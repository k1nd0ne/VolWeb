<!---
Filename : investigations.html
Analysis type : Windows & Linux
Description :
Display all the investigations and their analysis status.
The content is refreshed every 60 seconds using the "refresh()" function.
When an investigation is clicked, the sidebar is showed with the appropriate actions based on the status.
--->
{% extends "dashboard/base.html" %}
{% load static %}
{% block content%}
<div class="container">
    <div class="row" style="margin-bottom: 20px;">
        <div class="col align-items-center no-gutters d-flex justify-content-between" style="margin-top: 10px;">
            <h4 style="color: var(--bs-white);"><i class="fas fa-briefcase"></i>&nbsp;Investigations</h4><a href="{% url 'newinvest'%}" class="btn btn-primary btn-sm" type="button">Create a new investigation</a>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col align-items-center no-gutters d-flex justify-content-between"><input type="search" id="searchbar" class="search-bar form-control" placeholder="Search an investigation" style="color: var(--bs-gray-100);background: var(--bs-primary-rgb);"></div>
    </div>
    <div class="row mb-3">
        <div class="col align-items-center no-gutters d-flex justify-content-between">
            <div class="col-2 invest-table-header"><span class="invest-header">&nbsp;Name</span></div>
            <div class="col-4 invest-table-header"><span class="invest-header">&nbsp;File Name</span></div>
            <div class="col-2 invest-table-header"><span class="invest-header">&nbsp;Linked ISF</span></div>
            <div class="col-1 invest-table-header"><span class="invest-header">&nbsp;OS</span></div>
            <div class="col-2 text-center invest-table-header"><span class="invest-header">&nbsp;Status</span></div>
        </div>
    </div>
    {% if investigations %}
    <script>
      window.setInterval('refresh()', 60000);
    </script>
    <div id="all-investigations">
    {% for i in investigations %}
    <div class="row" data-role="investigations">
        <div class="col-12 align-items-center no-gutters d-flex justify-content-between">
          <a onclick="GetInvest({{i.id}})" class="col-12 align-items-center no-gutters d-flex justify-content-between invest-cell border-bottom" href="#">
                <div class="invest-cell col-2 align-items-center d-flex"><i class="fas fa-memory" style="font-size: 15px;transform: rotate(116deg);margin-right: 4px;"></i><span class="invest-header">{{i.title}}</span></div>
                <div class="invest-cell col-4 text-truncate"><span class="invest-header">{{i.name}}</span></div>
                {% if i.linked_isf %}
                <div class="invest-cell col-2"><span class="invest-header" style="color: var(--bs-gray-500);">{{i.linked_isf.name}}</span></div>
                {% else %}
                <div class="invest-cell col-2"><span class="invest-header" style="color: var(--bs-gray-500);">No linked ISF</span></div>
                {% endif %}

                {% if i.os_version == "Windows" %}
                <div class="invest-cell col-1"><span class="invest-header" style="color: var(--bs-cyan);">&nbsp;<i class="fab fa-windows"></i>&nbsp;Windows</span></div>
                {% endif %}
                {% if i.os_version == "Linux" %}
                <div class="invest-cell col-1"><span class="invest-header" style="color: #ff0f00;">&nbsp;<i class="fab fa-linux"></i>&nbsp;Linux</span></div>
                {% endif %}
                {% if i.os_version == "MacOs" %}
                <!--- Nothing yet -->
                {% endif %}

                {% if i.status == '4' %}
                <div class="col-2 text-center" style="color: var(--bs-body-bg);background: rgba(58,59,69,0);"><span class="invest-header" style="color: var(--bs-orange);">Partial results</span></div>
                {% elif i.status == '2' %}
                <div class="col-2 text-center" style="color: var(--bs-body-bg);background: rgba(58,59,69,0);"><span class="invest-header" style="color: var(--bs-green);">Ready</span></div>
                {% elif i.status == '1' %}
                <div class="col-2 text-center invest-item" style="color: var(--bs-body-bg);background: rgba(58,59,69,0);">
                  <svg height=20.420578 id=svg5 inkscape:export-filename=side.png inkscape:export-xdpi=96 inkscape:export-ydpi=96 inkscape:version="1.2 (dc2aeda, 2022-05-15)"sodipodi:docname=side.svg version=1.1 viewBox="0 0 1.0868235 23.893361"width=4.6457891 xml:space=preserve xmlns=http://www.w3.org/2000/svg xmlns:inkscape=http://www.inkscape.org/namespaces/inkscape xmlns:sodipodi=http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd xmlns:svg=http://www.w3.org/2000/svg><sodipodi:namedview bordercolor=#000000 borderopacity=0.25 id=namedview7 inkscape:current-layer=layer1 inkscape:cx=-19.812001 inkscape:cy=42.777106 inkscape:deskcolor=#d1d1d1 inkscape:document-units=mm inkscape:pagecheckerboard=0 inkscape:pageopacity=0.0 inkscape:showpageshadow=2 inkscape:window-height=1302 inkscape:window-maximized=1 inkscape:window-width=3440 inkscape:window-x=1728 inkscape:window-y=25 inkscape:zoom=9.5144351 pagecolor=#ffffff showgrid=false /><defs id=defs2 /><g id=layer1 inkscape:groupmode=layer inkscape:label="Calque 1"transform=translate(-106.95068,-6.8098632)><path class=svg-header-1 d="m 109.49242,7.1074427 c -4.79931,7.2235033 -5.68153,14.8989793 -0.24635,23.3033863"id=path2363 inkscape:export-filename=side.png inkscape:export-xdpi=96 inkscape:export-ydpi=96 sodipodi:nodetypes=cc style=fill:none;stroke:#4e73df;stroke-width:1px;stroke-opacity:1 /><path class=svg-header-2 d="m 109.79308,7.1113105 c -5.45682,7.2211055 -6.4599,14.8940335 -0.28009,23.2956505"id=path297 inkscape:export-filename=side.png inkscape:export-xdpi=96 inkscape:export-ydpi=96 sodipodi:nodetypes=cc style=fill:none;stroke:#54c4d4;stroke-width:1px;stroke-opacity:1 /><path class=svg-header-3 d="m 109.79731,7.1077022 c -4.86467,7.2233428 -5.7589,14.8986478 -0.2497,23.3028678"id=path3032 inkscape:export-filename=side.png inkscape:export-xdpi=96 inkscape:export-ydpi=96 sodipodi:nodetypes=cc style=fill:none;stroke:#e83e8c;stroke-width:1px;stroke-opacity:1 /></g></svg>
                  <span class="invest-header">{{i.percentage}}%</span>
                    <svg height=20.420578 id=svg5 inkscape:export-filename=side.png inkscape:export-xdpi=96 inkscape:export-ydpi=96 inkscape:version="1.2 (dc2aeda, 2022-05-15)"sodipodi:docname=side.svg version=1.1 viewBox="0 0 1.0868235 23.893361"width=4.6457891 xml:space=preserve xmlns=http://www.w3.org/2000/svg xmlns:inkscape=http://www.inkscape.org/namespaces/inkscape xmlns:sodipodi=http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd xmlns:svg=http://www.w3.org/2000/svg><sodipodi:namedview bordercolor=#000000 borderopacity=0.25 id=namedview7 inkscape:current-layer=layer1 inkscape:cx=-21.388553 inkscape:cy=42.987313 inkscape:deskcolor=#d1d1d1 inkscape:document-units=mm inkscape:pagecheckerboard=0 inkscape:pageopacity=0.0 inkscape:showpageshadow=2 inkscape:window-height=1302 inkscape:window-maximized=1 inkscape:window-width=3440 inkscape:window-x=1728 inkscape:window-y=25 inkscape:zoom=9.5144351 pagecolor=#ffffff showgrid=false /><defs id=defs2 /><g id=layer1 inkscape:groupmode=layer inkscape:label="Calque 1"transform=translate(-106.95068,-6.8098632)><path class=svg-header-1 d="m 105.49577,7.1074427 c 4.79931,7.2235033 5.68153,14.8989793 0.24635,23.3033863"id=path2363 inkscape:export-filename=side.png inkscape:export-xdpi=96 inkscape:export-ydpi=96 sodipodi:nodetypes=cc style=fill:none;stroke:#4e73df;stroke-width:1px;stroke-opacity:1 /><path class=svg-header-2 d="m 105.19511,7.1113105 c 5.45682,7.2211055 6.4599,14.8940335 0.28009,23.2956505"id=path297 inkscape:export-filename=side.png inkscape:export-xdpi=96 inkscape:export-ydpi=96 sodipodi:nodetypes=cc style=fill:none;stroke:#54c4d4;stroke-width:1px;stroke-opacity:1 /><path class=svg-header-3 d="m 105.19088,7.1077022 c 4.86467,7.2233428 5.7589,14.8986478 0.2497,23.3028678"id=path3032 inkscape:export-filename=side.png inkscape:export-xdpi=96 inkscape:export-ydpi=96 sodipodi:nodetypes=cc style=fill:none;stroke:#e83e8c;stroke-width:1px;stroke-opacity:1 /></g></svg>

                </div>
                {% else %}
                <div class="col-2 text-center" style="color: var(--bs-body-bg);background: rgba(58,59,69,0);"><span class="invest-header" style="color: var(--bs-pink);">Not started</span></div>
                {% endif %}
            </a></div>
    </div>
    {% endfor %}
    </div>
    {% endif %}
</div>
<div class="sidebar2">
    <div class="dismiss" style="background: var(--bs-blue);"><i class="fa fa-caret-right"></i></div>
    <div class="brand" style="padding-bottom: 14px;padding-top: 17px;"><i class="fa fa-windows" style="font-size: 43px;padding-right: 16px;"></i><a class="sidebar-invest-name navbar-brand" href="index.html" style="color: var(--bs-pink);">Investigation Name</a></div>
    <div class="col-md-10 mb-4" style="margin-left: 25px;margin-top: 20px;"><span style="color: var(--bs-cyan);">Description</span>
        <p class="sidebar-text sidebar-invest-desc">Description here</p>
        <hr>
    </div>
    <div class="col-md-10 mb-4" style="margin-left: 25px;margin-top: 20px;"><span style="color: var(--bs-cyan);">Team</span>
        <p class="sidebar-text sidebar-invest-team">Team here</p>
        <hr>
    </div>
    <div class="col-md-10 mb-4" style="margin-left: 25px;margin-top: 20px;"><span style="color: var(--bs-cyan);">Actions</span>

      <a class="invest-card-link card-start a-start" href="#">
            <div class="card shadow border-start-primary invest-card" style="background: rgba(0,0,0,0.25);border-style: none;margin-top: 10px;">
                <div class="card-body" style="color: rgb(255,255,255);border-style: none;">
                    <div class="row align-items-center no-gutters">
                        <div class="col-auto"><i class="fas fa-rocket fa-2x text-gray-600"></i></div>
                        <div class="col me-2">
                            <div class="text-uppercase text-primary fw-bold text-xs mb-1"><span style="color: var(--bs-purple);">Start memory analysis</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </a>
        <a class="invest-card-link card-review a-review" href="#">
            <div class="card shadow border-start-primary invest-card" style="background: rgba(0,0,0,0.25);border-style: none;margin-top: 10px;">
                <div class="card-body" style="color: rgb(255,255,255);border-style: none;">
                    <div class="row align-items-center no-gutters">
                        <div class="col-auto"><i class="fas fa-glasses fa-2x text-gray-600"></i></div>
                        <div class="col me-2">
                            <div class="text-uppercase text-primary fw-bold text-xs mb-1"><span style="color: var(--bs-cyan);">Review investigation</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </a>

        <a class="invest-card-link card-cancel a-cancel" href="#">
            <div class="card shadow border-start-primary invest-card" style="background: rgba(0,0,0,0.25);border-style: none;margin-top: 10px;">
                <div class="card-body" style="color: rgb(255,255,255);border-style: none;">
                    <div class="row align-items-center no-gutters">
                        <div class="col-auto"><i class="far fa-window-close fa-2x text-gray-600"></i></div>
                        <div class="col me-2">
                            <div class="text-uppercase text-primary fw-bold text-xs mb-1"><span style="color: var(--bs-orange);">Cancel memory analysis</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </a>

        <a class="invest-card-link card-delete a-delete" href="#">
            <div class="card shadow border-start-primary invest-card" style="background: rgba(0,0,0,0.25);border-style: none;margin-top: 10px;">
                <div class="card-body" style="color: rgb(255,255,255);border-style: none;">
                    <div class="row align-items-center no-gutters">
                        <div class="col-auto"><i class="far fa-trash-alt fa-2x text-gray-600"></i></div>
                        <div class="col me-2">
                            <div class="text-uppercase text-primary fw-bold text-xs mb-1"><span style="color: var(--bs-pink);">Delete this investigation</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </a>
        <hr>
    </div>
</div>

<form style="all: unset;" id='reviewform' action="{% url 'reviewinvest' %}" method="GET">
</form>

<form method="POST">
  {% csrf_token %}
</form>


<div class="overlay"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>

  const dismiss = document.querySelector(".dismiss");
  const sidebar = document.querySelector(".sidebar2");
  const overlay = document.querySelector(".overlay");

  // Refresh only part of the page.
  function refresh() {
    //Delete the table first and show spinner
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
    $('#all-investigations').html("")
    $('.spinner-main').show();
    $.ajax({
      url: "{% url 'investigations' %}",
      success: function(data) {
        var parser = new DOMParser();
        var wrapper = parser.parseFromString(data, "text/html");
        invests = wrapper.getElementById('all-investigations');
        $('.spinner-main').hide();
        $('#all-investigations').html(invests);
      }
    });
  }

  function ReviewInvest(case_id){
      $("#reviewform").append("<input class='d-none' name='sa_case_id' value="+case_id+">");
      $("#reviewform").submit();
  }


  /* The user decided to click on the "Start analysis" btn */
  function StartAnalysis(case_id){
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const fd = new FormData();
    fd.append('csrfmiddlewaretoken', csrftoken);
    fd.append('sa_case_id', case_id);
    $.ajax({
      type:'POST',
      url: "{% url 'start_analysis' %}",
      enctype: 'multipart/form-data',
      data: fd,
      beforeSend: function(){
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        $('#proc-message-info').html("Starting...");
        $('.toast-proc-info').toast('show');
      },
      success: function(response){
        if (response['message'] == "success") {
          $('#proc-success-message').html("Analysis started.");
          $('.toast-proc-success').toast('show');
          refresh();
        }
        if (response['message'] == "error")
        {
          $('#proc-error-message').html("Invalid request");
          $('.toast-proc-error').toast('show');
        }

      },
      error: function(error){
        $('#proc-error-message').html("Something went wrong (500) ");
        $('.toast-proc-error').toast('show');
      },
      cache: false,
      contentType : false,
      processData: false
    });
  }

  /* Cancel Analysis function */
  function CancelAnalysis(case_id){
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const fd = new FormData();
    fd.append('csrfmiddlewaretoken', csrftoken);
    fd.append('sa_case_id', case_id);
    $.ajax({
      type:'POST',
      url: "{% url 'cancel_analysis' %}",
      enctype: 'multipart/form-data',
      data: fd,
      beforeSend: function(){
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        $('#proc-message-info').html("Canceling...");
        $('.toast-proc-info').toast('show');
      },
      success: function(response){
        if (response['message'] == "success") {
          $('#proc-success-message').html("Analysis canceled.");
          $('.toast-proc-success').toast('show');
          refresh();
        }
        if (response['message'] == "error")
        {
          $('#proc-error-message').html("Invalid request");
          $('.toast-proc-error').toast('show');
        }
      },
      error: function(error){
        $('#proc-error-message').html("Something went wrong (500) ");
        $('.toast-proc-error').toast('show');
      },
      cache: false,
      contentType : false,
      processData: false
    });
  }


  /* Delete investigation script */
  function DeleteAnalysis(case_id){
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const fd = new FormData();
    fd.append('csrfmiddlewaretoken', csrftoken);
    fd.append('sa_case_id', case_id);
    $.ajax({
      type:'POST',
      url: "{% url 'remove_analysis' %}",
      enctype: 'multipart/form-data',
      data: fd,
      beforeSend: function(){
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        $('#proc-message-info').html("Deleting...");
        $('.toast-proc-info').toast('show');
      },
      success: function(response){
        if (response['message'] == "success") {
          $('#actions').hide();
          $('#proc-success-message').html("Analysis removed.");
          $('.toast-proc-success').toast('show');
          refresh();
        }
        if (response['message'] == "error")
        {
          $('#proc-error-message').html("Invalid request");
          $('.toast-proc-error').toast('show');
        }
      },
      error: function(error){
        $('#proc-error-message').html("Something went wrong (500) ");
        $('.toast-proc-error').toast('show');
      },
      cache: false,
      contentType : false,
      processData: false
    });
  }

  if (sidebar) {
  		dismiss.addEventListener('click', () => {sidebar.classList.remove('active'),overlay.classList.remove('active')});
  		overlay.addEventListener('click', () => {sidebar.classList.remove('active'),overlay.classList.remove('active')});
  		function GetInvest(case_id){
  			$.get("{% url 'get_invest' %}", {sa_case_id:case_id}, // url
  		    function (response, textStatus, jqXHR) {  // success callback
  		        if(textStatus == "success"){
  		          if (response['message'] == "success") {
  								$(".sidebar-invest-name").html(response['result'][0].fields.title);
                  $(".sidebar-invest-desc").html(response['result'][0].fields.description);
                  $(".sidebar-invest-team").html(response['result'][0].fields.investigators);


  		            if (response['result'][0].fields.status == "0") {
                    $(".invest-card-link").addClass("d-none");
                    $(".card-start").removeClass("d-none");
                    $(".card-delete").removeClass("d-none");
                    $(".a-start").attr("onclick", "StartAnalysis("+case_id+");")
                    $(".a-delete").attr("onclick", "DeleteAnalysis("+case_id+");")
  		            }
  		            if (response['result'][0].fields.status == "1") {
                    $(".invest-card-link").addClass("d-none");
                    $(".card-delete").removeClass("d-none");
                    $(".card-cancel").removeClass("d-none");
                    $(".a-cancel").attr("onclick", "CancelAnalysis("+case_id+");")
                    $(".a-delete").attr("onclick", "DeleteAnalysis("+case_id+");")


  		            }
  		            if (response['result'][0].fields.status == "2") {
                    $(".invest-card-link").addClass("d-none");
                    $(".card-delete").removeClass("d-none");
                    $(".card-start").removeClass("d-none");
                    $(".card-review").removeClass("d-none");
                    $(".a-review").attr("onclick", "ReviewInvest("+case_id+");")
                    $(".a-start").attr("onclick", "StartAnalysis("+case_id+");")
                    $(".a-delete").attr("onclick", "DeleteAnalysis("+case_id+");")


  		            }
  		            if (response['result'][0].fields.status == "4") {
                    $(".invest-card-link").addClass("d-none");
                    $(".card-review").removeClass("d-none");
                    $(".card-start").removeClass("d-none");
                    $(".card-delete").removeClass("d-none");
                    $(".a-review").attr("onclick", "ReviewInvest("+case_id+");")
                    $(".a-start").attr("onclick", "StartAnalysis("+case_id+");")
                    $(".a-delete").attr("onclick", "DeleteAnalysis("+case_id+");")
  		            }
  		          }
  		          if (response['message'] == "error")
  		          {
  		            $('#proc-error-message').html("Something went wrong getting the linked iocs.");
  		            $('.toast-proc-error').toast('show');
  		          }
  		          $('.invest-details').show();
  		          $('.spinner-invest').hide();
  		        }
  		  });

  			sidebar.classList.add('active');
  			overlay.classList.add('active');
  		}
  }

  $("#searchbar").on("keyup", function() {
    var value = $(this).val().toLowerCase();
    $('div[data-role="investigations"]').filter(function() {
      $(this).toggle($(this).find('span').text().toLowerCase().indexOf(value) > -1)
    });
  });


</script>
{% endblock content %}
